<template>
  <div class="factor-library-page">
    <!-- ‰∏ÄÁ∫ßTabÔºöÂ§ßÂäüËÉΩÊ®°Âùó -->
    <el-tabs v-model="activeMainTab" class="main-tabs" @tab-change="handleMainTabChange">
      <el-tab-pane label="üìö Âõ†Â≠êÂπøÂú∫" name="plaza">
        <!-- ‰∫åÁ∫ßTabÔºöËßÜÂõæÂàáÊç¢ -->
        <el-tabs v-model="activeViewTab" class="view-tabs" @tab-change="handleViewTabChange">
          <el-tab-pane name="category">
            <template #label>
              <span>üìä ÊåâÂàÜÁ±ªÊµèËßà ({{ totalCount }})</span>
            </template>
          </el-tab-pane>
          <el-tab-pane name="tags">
            <template #label>
              <span>üè∑Ô∏è ÊåâÊ†áÁ≠æÁ≠õÈÄâ</span>
            </template>
          </el-tab-pane>
          <el-tab-pane name="performance">
            <template #label>
              <span>üìà ÊåâÊÄßËÉΩÊéíÂ∫è</span>
            </template>
          </el-tab-pane>
        </el-tabs>

        <!-- ÊêúÁ¥¢Ê†è -->
        <div class="search-bar">
          <el-input
            v-model="searchKeyword"
            placeholder="ÊêúÁ¥¢Âõ†Â≠ê‰ª£Á†Å„ÄÅÂêçÁß∞..."
            clearable
            @keyup.enter="handleSearch"
          >
            <template #prefix>
              <el-icon><Search /></el-icon>
            </template>
          </el-input>
          <el-button type="primary" @click="handleSearch">
            <el-icon><Refresh /></el-icon>
            Âà∑Êñ∞
          </el-button>
        </div>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫ÔºöÂ∑¶‰∏≠Âè≥‰∏âÊ†è -->
        <div class="content-layout">
          <!-- Â∑¶‰æßÈù¢ÊùøÔºöÊ†πÊçÆTabÊòæÁ§∫‰∏çÂêåÂÜÖÂÆπ -->
          
          <!-- Tab1: ÂàÜÁ±ªÊ†ë -->
          <div v-if="activeViewTab === 'category'" class="left-panel">
            <div class="panel-header">
              <span>Âõ†Â≠êÂàÜÁ±ª</span>
              <el-button text @click="expandAll">
                <el-icon><Expand /></el-icon>
                {{ allExpanded ? 'ÂÖ®ÈÉ®Êî∂Ëµ∑' : 'ÂÖ®ÈÉ®Â±ïÂºÄ' }}
              </el-button>
            </div>
            <div class="category-tree" v-loading="loadingCategories">
              <el-tree
                ref="treeRef"
                :data="treeDataWithUniqueKeys"
                :props="treeProps"
                :expand-on-click-node="false"
                node-key="uniqueKey"
                highlight-current
                @node-click="handleNodeClick"
              >
                <template #default="{ data }">
                  <div class="tree-node">
                    <span class="node-label">{{ data.name }}</span>
                    <span class="node-count" v-if="data.factor_count !== undefined">
                      ({{ data.factor_count }})
                    </span>
                  </div>
                </template>
              </el-tree>
            </div>
          </div>
          
          <!-- Tab2: Ê†áÁ≠æÂàóË°® -->
          <div v-else-if="activeViewTab === 'tags'" class="left-panel">
            <div class="panel-header">
              <span>Âõ†Â≠êÊ†áÁ≠æ</span>
              <el-button text size="small" @click="clearAllTags">
                <el-icon><Refresh /></el-icon>
                Ê∏ÖÁ©∫
              </el-button>
            </div>
            <div class="tags-container" v-loading="loadingTags">
              <div v-for="(tags, tagType) in tagGroups" :key="tagType" class="tag-group">
                <div class="tag-group-title">{{ getTagTypeLabel(tagType) }}</div>
                <div class="tag-items">
                  <el-check-tag
                    v-for="tag in tags"
                    :key="tag.id"
                    :checked="selectedTags.includes(tag.tag_value)"
                    @change="toggleTag(tag.tag_value)"
                    class="tag-item"
                  >
                    {{ tag.tag_name }}
                  </el-check-tag>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tab3: ÊÄßËÉΩÊéíÂ∫èÔºàÂç†‰ΩçÔºâ -->
          <div v-else class="left-panel">
            <div class="panel-header">
              <span>ÊÄßËÉΩÊåáÊ†á</span>
            </div>
            <div class="empty-state">
              <el-empty description="ÂäüËÉΩÂºÄÂèë‰∏≠..." :image-size="80" />
            </div>
          </div>

          <!-- ‰∏≠Èó¥ÔºöÂõ†Â≠êÂàóË°® -->
          <div class="middle-panel">
            <div class="panel-header">
              <span>Âõ†Â≠êÂàóË°®</span>
              <el-select v-model="selectedStatus" size="small" style="width: 130px" @change="loadFactors">
                <el-option
                  v-for="status in statusOptions"
                  :key="status.value"
                  :label="status.icon + ' ' + status.label"
                  :value="status.value"
                />
              </el-select>
            </div>
            <div class="factor-list" v-loading="loadingFactors">
              <div
                v-for="factor in displayedFactors"
                :key="factor.factor_id"
                class="factor-card"
                :class="{ active: selectedFactor?.factor_id === factor.factor_id }"
                @click="selectFactor(factor)"
              >
                <div class="factor-header">
                  <div class="factor-code">{{ factor.factor_code }}</div>
                  <el-tag size="small" :type="getStatusColor(factor.status)">
                    {{ getStatusLabel(factor.status) }}
                  </el-tag>
                </div>
                <div class="factor-name">{{ factor.factor_name }}</div>
                <div class="factor-category">
                  {{ factor.category_l1_name }} / {{ factor.category_l2_name }} / {{ factor.category_l3_name }}
                </div>
                <div class="factor-metrics">
                  <el-tag size="small" type="success" effect="plain">
                    IC IR: {{ factor.ic_ir?.toFixed(2) || '-' }}
                  </el-tag>
                  <el-tag size="small" type="primary" effect="plain">
                    Rank IC IR: {{ factor.rank_ic_ir?.toFixed(2) || '-' }}
                  </el-tag>
                </div>
              </div>
              
              <!-- Á©∫Áä∂ÊÄÅ -->
              <el-empty 
                v-if="!loadingFactors && displayedFactors.length === 0" 
                description="ËØ•ÂàÜÁ±ª‰∏ãÊöÇÊó†Âõ†Â≠ê"
                :image-size="100"
              />
              
              <!-- ÂàÜÈ°µ -->
              <div v-if="pagination.total > pagination.page_size" class="pagination-wrapper">
                <el-pagination
                  v-model:current-page="pagination.page"
                  v-model:page-size="pagination.page_size"
                  :total="pagination.total"
                  :page-sizes="[20, 50, 100]"
                  layout="total, sizes, prev, pager, next"
                  small
                  @current-change="loadFactors"
                  @size-change="loadFactors"
                />
              </div>
            </div>
          </div>

          <!-- Âè≥‰æßÔºöËØ¶ÊÉÖÈù¢Êùø -->
          <div class="right-panel">
            <div class="panel-header">
              <span>Âõ†Â≠êËØ¶ÊÉÖ</span>
            </div>
            <div class="panel-content">
              <div v-if="!selectedFactor" class="empty-state">
                <el-empty description="ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™Âõ†Â≠êÊü•ÁúãËØ¶ÊÉÖ" :image-size="120" />
              </div>
              
              <div v-else class="factor-detail" v-loading="loadingDetail">
              <!-- ËØ¶ÊÉÖÂ§¥ÈÉ® -->
              <div class="detail-header">
                <h3>{{ selectedFactorDetail?.factor_name || selectedFactor.factor_name }}</h3>
                <el-tag :type="getStatusColor(selectedFactorDetail?.status || selectedFactor.status)">
                  {{ getStatusLabel(selectedFactorDetail?.status || selectedFactor.status) }}
                </el-tag>
              </div>

              <!-- Âü∫Êú¨‰ø°ÊÅØ -->
              <el-card shadow="never" class="info-section">
                <template #header>
                  <span>Âü∫Êú¨‰ø°ÊÅØ</span>
                </template>
                <el-descriptions :column="1" size="small" border>
                  <el-descriptions-item label="Âõ†Â≠ê‰ª£Á†Å">
                    <el-text style="font-family: monospace; font-weight: 500;">
                      {{ selectedFactorDetail?.factor_code }}
                    </el-text>
                  </el-descriptions-item>
                  <el-descriptions-item label="Ëã±ÊñáÂêçÁß∞">
                    {{ selectedFactorDetail?.factor_name_en || '-' }}
                  </el-descriptions-item>
                  <el-descriptions-item label="ÂàÜÁ±ª">
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                      <el-tag size="small">{{ selectedFactorDetail?.category_l1_name }}</el-tag>
                      <el-tag size="small" type="success">{{ selectedFactorDetail?.category_l2_name }}</el-tag>
                      <el-tag size="small" type="warning">{{ selectedFactorDetail?.category_l3_name }}</el-tag>
                    </div>
                  </el-descriptions-item>
                  <el-descriptions-item label="Êï∞ÊçÆÁ±ªÂûã">
                    {{ selectedFactorDetail?.data_type || '-' }}
                  </el-descriptions-item>
                  <el-descriptions-item label="Âçï‰Ωç">
                    {{ selectedFactorDetail?.unit || '-' }}
                  </el-descriptions-item>
                  <el-descriptions-item label="ÂõûÁúãÂë®Êúü">
                    {{ selectedFactorDetail?.lookback_period || '-' }} Â§©
                  </el-descriptions-item>
                  <el-descriptions-item label="Âõ†Â≠êÊèèËø∞">
                    {{ selectedFactorDetail?.description || '-' }}
                  </el-descriptions-item>
                  <el-descriptions-item label="ËÆ°ÁÆóÂÖ¨Âºè">
                    <el-text style="font-family: monospace; font-size: 12px; word-break: break-all;">
                      {{ selectedFactorDetail?.formula || '-' }}
                    </el-text>
                  </el-descriptions-item>
                </el-descriptions>

                <!-- Ê†áÁ≠æ -->
                <div v-if="selectedFactorDetail?.tags && selectedFactorDetail.tags.length > 0" class="tags-section">
                  <div class="section-title">Ê†áÁ≠æ</div>
                  <el-tag
                    v-for="tag in selectedFactorDetail.tags"
                    :key="tag.id"
                    size="small"
                    class="factor-tag"
                  >
                    {{ tag.tag_name }}
                  </el-tag>
                </div>
              </el-card>

              <!-- ÊÄßËÉΩÊåáÊ†á -->
              <el-card shadow="never" class="info-section">
                <template #header>
                  <div class="section-header">
                    <span>ÊÄßËÉΩÊåáÊ†á</span>
                    <el-button size="small" text @click="viewPerformanceTrend">
                      <el-icon><TrendCharts /></el-icon>
                      Êü•ÁúãË∂ãÂäø
                    </el-button>
                  </div>
                </template>
                <el-descriptions :column="2" size="small" border>
                  <el-descriptions-item label="ICÂùáÂÄº">
                    <el-text :type="getICColor(selectedFactorDetail?.ic_mean)">
                      {{ selectedFactorDetail?.ic_mean?.toFixed(4) || '-' }}
                    </el-text>
                  </el-descriptions-item>
                  <el-descriptions-item label="ICÊ†áÂáÜÂ∑Æ">
                    {{ selectedFactorDetail?.ic_std?.toFixed(4) || '-' }}
                  </el-descriptions-item>
                  <el-descriptions-item label="IC IR">
                    <el-text type="primary" style="font-weight: bold;">
                      {{ selectedFactorDetail?.ic_ir?.toFixed(2) || '-' }}
                    </el-text>
                  </el-descriptions-item>
                  <el-descriptions-item label="Rank IC IR">
                    <el-text type="success" style="font-weight: bold;">
                      {{ selectedFactorDetail?.rank_ic_ir?.toFixed(2) || '-' }}
                    </el-text>
                  </el-descriptions-item>
                  <el-descriptions-item label="Êç¢ÊâãÁéá">
                    {{ (selectedFactorDetail?.turnover * 100)?.toFixed(2) || '-' }}%
                  </el-descriptions-item>
                  <el-descriptions-item label="Â§èÊôÆÊØîÁéá">
                    {{ selectedFactorDetail?.sharpe_ratio?.toFixed(2) || '-' }}
                  </el-descriptions-item>
                  <el-descriptions-item label="ÊúÄÂ§ßÂõûÊí§">
                    <el-text type="danger">
                      {{ (selectedFactorDetail?.max_drawdown * 100)?.toFixed(2) || '-' }}%
                    </el-text>
                  </el-descriptions-item>
                  <el-descriptions-item label="Ë¶ÜÁõñÁéá">
                    {{ (selectedFactorDetail?.coverage_rate * 100)?.toFixed(2) || '-' }}%
                  </el-descriptions-item>
                </el-descriptions>
              </el-card>

              <!-- Êï∞ÊçÆËåÉÂõ¥ -->
              <el-card shadow="never" class="info-section">
                <template #header>
                  <span>Êï∞ÊçÆËåÉÂõ¥</span>
                </template>
                <el-descriptions :column="1" size="small" border>
                  <el-descriptions-item label="Êï∞ÊçÆËµ∑Âßã">
                    {{ selectedFactorDetail?.data_start_date || '-' }}
                  </el-descriptions-item>
                  <el-descriptions-item label="Êï∞ÊçÆÁªìÊùü">
                    {{ selectedFactorDetail?.data_end_date || '-' }}
                  </el-descriptions-item>
                  <el-descriptions-item label="ÊúÄÂêéÊõ¥Êñ∞">
                    {{ selectedFactorDetail?.last_performance_date || '-' }}
                  </el-descriptions-item>
                </el-descriptions>
              </el-card>

              <!-- Êìç‰ΩúÊåâÈíÆ -->
              <div class="action-buttons">
                <el-button type="primary" size="large" :icon="Download" @click="showDownloadDialog">
                  ‰∏ãËΩΩÂõ†Â≠êÊï∞ÊçÆ
                </el-button>
              </div>
            </div>
            </div>
          </div>
        </div>
      </el-tab-pane>

      <!-- Tab2: Âõ†Â≠êÂõûÊµã‰∏éÊèê‰∫§ -->
      <el-tab-pane label="üß™ Âõ†Â≠êÂõûÊµã‰∏éÊèê‰∫§" name="backtest">
        <div class="backtest-submit-container">
          <!-- ‰∏âÊ≠•ÊµÅÁ®ã -->
          <el-steps :active="currentStep" align-center class="steps-container">
            <el-step title="ÂÆö‰πâÂõ†Â≠ê" description="Â°´ÂÜôÂõ†Â≠ê‰ø°ÊÅØ" icon="Edit" />
            <el-step title="Êé®ÈÄÅÂõûÊµã" description="Êü•ÁúãÂõûÊµãÁªìÊûú" icon="TrendCharts" />
            <el-step title="Êèê‰∫§ÂÆ°Ê†∏" description="Êª°ÊÑèÂêéÊèê‰∫§ÂÖ•Â∫ì" icon="Upload" />
          </el-steps>

          <!-- Ê≠•È™§1: ÂÆö‰πâÂõ†Â≠êÔºàÂ∑¶Âè≥ÂàÜÊ†èÂ∏ÉÂ±ÄÔºâ -->
          <el-card v-show="currentStep === 0" class="step-card" shadow="never">
            <template #header>
              <div class="card-header">
                <span>üìù Á¨¨‰∏ÄÊ≠•ÔºöÂÆö‰πâÂõ†Â≠ê</span>
              </div>
            </template>
            
            <div class="define-layout">
              <!-- Â∑¶‰æßÂØºËà™ -->
              <div class="define-nav">
                <div 
                  v-for="section in defineSections" 
                  :key="section.key"
                  :class="['nav-item', { active: activeDefineSection === section.key }]"
                  @click="activeDefineSection = section.key"
                >
                  <span class="nav-icon">{{ section.icon }}</span>
                  <span class="nav-label">{{ section.label }}</span>
                  <span v-if="isSectionCompleted(section.key)" class="check-icon">‚úì</span>
                </div>
              </div>

              <!-- Âè≥‰æßÂÜÖÂÆπÂå∫ -->
              <div class="define-content">
                <!-- Âü∫Êú¨‰ø°ÊÅØ -->
                <div v-show="activeDefineSection === 'basic'" class="section-panel">
                  <h3 class="section-title">üìù Âü∫Êú¨‰ø°ÊÅØ</h3>
                  <el-form :model="factorForm" label-width="100px">
                    <el-form-item label="Âõ†Â≠êÂêçÁß∞" required>
                      <el-input 
                        v-model="factorForm.name" 
                        placeholder="‰æãÂ¶Ç: 5Êó•Âä®ËÉΩÂõ†Â≠ê"
                        size="large"
                      />
                    </el-form-item>
                    <el-form-item label="Âõ†Â≠êÊèèËø∞">
                      <el-input
                        v-model="factorForm.description"
                        type="textarea"
                        :rows="4"
                        placeholder="ÁÆÄË¶ÅÊèèËø∞Âõ†Â≠êÁöÑÂê´‰πâ„ÄÅÁî®ÈÄîÂíåÁâπÁÇπ..."
                      />
                    </el-form-item>
                    <el-form-item label="Âõ†Â≠ê‰ΩúËÄÖ">
                      <el-input v-model="factorForm.author" disabled size="large">
                        <template #prepend>
                          <el-icon><User /></el-icon>
                        </template>
                      </el-input>
                      <div class="form-tip">
                        <el-text type="info" size="small">‰ΩúËÄÖ‰ø°ÊÅØ‰ªéÂΩìÂâçAPI KeyËá™Âä®Ëé∑Âèñ</el-text>
                      </div>
                    </el-form-item>
                  </el-form>
                </div>

                <!-- ÂàÜÁ±ª‰ø°ÊÅØ -->
                <div v-show="activeDefineSection === 'category'" class="section-panel">
                  <h3 class="section-title">üìÅ ÂàÜÁ±ª‰ø°ÊÅØ</h3>
                  <el-form :model="factorForm" label-width="100px">
                    <el-form-item label="Âõ†Â≠êÂàÜÁ±ª" required>
                      <el-cascader
                        v-model="factorForm.categoryPath"
                        :options="treeDataWithUniqueKeys"
                        :props="{ label: 'name', value: 'id', children: 'children', emitPath: true }"
                        placeholder="ËØ∑ÈÄâÊã©ÂàÜÁ±ª"
                        size="large"
                        style="width: 100%"
                      />
                      <div class="form-tip">
                        <el-text type="info" size="small">ËØ∑ÈÄâÊã©ÊúÄÂÖ∑‰ΩìÁöÑ‰∏âÁ∫ßÂàÜÁ±ª</el-text>
                      </div>
                    </el-form-item>
                    <el-form-item label="Â∑≤ÈÄâÂàÜÁ±ª">
                      <el-tag v-if="getSelectedCategoryName()" type="primary" size="large">
                        {{ getSelectedCategoryName() }}
                      </el-tag>
                      <el-text v-else type="info">Êú™ÈÄâÊã©</el-text>
                    </el-form-item>
                  </el-form>
                </div>

                <!-- Ê†áÁ≠æ‰ø°ÊÅØ -->
                <div v-show="activeDefineSection === 'tags'" class="section-panel">
                  <h3 class="section-title">üè∑Ô∏è Ê†áÁ≠æ‰ø°ÊÅØ</h3>
                  <div class="tags-section">
                    <el-alert 
                      title="Ê†áÁ≠æËØ¥Êòé" 
                      type="info" 
                      :closable="false"
                      style="margin-bottom: 20px"
                    >
                      <div>Ê†áÁ≠æÁî®‰∫éÊõ¥Á≤æÁ°ÆÂú∞ÊèèËø∞Âõ†Â≠êÁâπÂæÅÔºå‰æø‰∫éÂêéÁª≠Ê£ÄÁ¥¢ÂíåÁ≠õÈÄâ</div>
                    </el-alert>
                    
                    <div v-for="(tags, tagType) in tagGroups" :key="tagType" class="tag-group-block">
                      <div class="tag-group-header">
                        <span class="tag-type-title">{{ getTagTypeLabel(tagType) }}</span>
                        <el-text type="info" size="small">Â∑≤ÈÄâ {{ getSelectedTagCountByType(tagType) }} ‰∏™</el-text>
                      </div>
                      <div class="tag-items-block">
                        <el-check-tag
                          v-for="tag in tags"
                          :key="tag.id"
                          :checked="factorForm.tags.includes(tag.tag_value)"
                          @change="toggleFactorTag(tag.tag_value)"
                        >
                          {{ tag.tag_name }}
                        </el-check-tag>
                      </div>
                    </div>
                    
                    <div v-if="Object.keys(tagGroups).length === 0" class="no-tags">
                      <el-empty description="ÊöÇÊó†ÂèØÈÄâÊ†áÁ≠æ" />
                    </div>
                  </div>
                </div>

                <!-- ‰ª£Á†Å‰ø°ÊÅØ -->
                <div v-show="activeDefineSection === 'code'" class="section-panel">
                  <h3 class="section-title">üíª ‰ª£Á†Å‰ø°ÊÅØ</h3>
                  <el-form :model="factorForm" label-width="100px">
                    <el-form-item label="ÂÆûÁé∞ÊñπÂºè">
                      <el-radio-group v-model="factorForm.codeType" size="large">
                        <el-radio-button value="formula">üìê ÂÖ¨ÂºèË°®ËææÂºè</el-radio-button>
                        <el-radio-button value="python">üêç Python‰ª£Á†Å</el-radio-button>
                        <el-radio-button value="cpp">‚ö° C++‰ª£Á†Å</el-radio-button>
                      </el-radio-group>
                    </el-form-item>
                    
                    <el-form-item label="Âõ†Â≠ê‰ª£Á†Å" required>
                      <el-input
                        v-model="factorForm.formula"
                        type="textarea"
                        :autosize="{ minRows: 6, maxRows: 30 }"
                        :placeholder="getCodePlaceholder()"
                        class="code-editor"
                      />
                      <div class="form-tip">
                        <el-text type="info" size="small">{{ getCodeTip() }}</el-text>
                      </div>
                    </el-form-item>
                    
                    <el-form-item label="ÂõûÊµãÂë®Êúü">
                      <el-date-picker
                        v-model="factorForm.backtestRange"
                        type="daterange"
                        range-separator="Ëá≥"
                        start-placeholder="ÂºÄÂßãÊó•Êúü"
                        end-placeholder="ÁªìÊùüÊó•Êúü"
                        value-format="YYYY-MM-DD"
                        size="large"
                        style="width: 100%"
                      />
                    </el-form-item>
                  </el-form>
                </div>
              </div>
            </div>

            <div class="step-actions">
              <el-button type="primary" size="large" @click="goToBacktest" :disabled="!canGoToBacktest">
                ÂÆåÊàêÂÆö‰πâÔºåÊé®ÈÄÅÂõûÊµã
                <el-icon class="el-icon--right"><ArrowRight /></el-icon>
              </el-button>
            </div>
          </el-card>

          <!-- Ê≠•È™§2: Êé®ÈÄÅÂõûÊµã -->
          <el-card v-show="currentStep === 1" class="step-card" shadow="never">
            <template #header>
              <div class="card-header">
                <span>üìä Á¨¨‰∫åÊ≠•ÔºöÊé®ÈÄÅÂõûÊµã</span>
              </div>
            </template>
            <div class="backtest-section">
              <el-alert
                title="ÂõûÊµãËØ¥Êòé"
                type="info"
                :closable="false"
                show-icon
                class="backtest-alert"
              >
                <div>Ê≠§Ê≠•È™§‰ªÖËøõË°åÂõûÊµãÈ™åËØÅÔºå<strong>‰∏ç‰ºöÂ∞ÜÂõ†Â≠êÂÜôÂÖ•Êï∞ÊçÆÂ∫ì</strong>„ÄÇÂè™ÊúâÁ¨¨‰∏âÊ≠•"Êèê‰∫§ÂÆ°Ê†∏"ÂêéÊâç‰ºöÂÖ•Â∫ì„ÄÇ</div>
              </el-alert>

              <!-- Âõ†Â≠ê‰ø°ÊÅØÂ±ïÁ§∫ -->
              <div class="factor-info">
                <el-descriptions title="Âõ†Â≠ê‰ø°ÊÅØ" :column="2" border>
                  <el-descriptions-item label="Âõ†Â≠êÂêçÁß∞">{{ factorForm.name }}</el-descriptions-item>
                  <el-descriptions-item label="Âõ†Â≠êÂÖ¨Âºè">{{ factorForm.formula }}</el-descriptions-item>
                  <el-descriptions-item label="ÂõûÊµãÂë®Êúü" :span="2">
                    {{ factorForm.backtestRange?.[0] }} Ëá≥ {{ factorForm.backtestRange?.[1] }}
                  </el-descriptions-item>
                </el-descriptions>
              </div>

              <!-- ÂõûÊµãËøõÂ∫¶ -->
              <div v-if="backtestStatus === 'running'" class="backtest-progress">
                <el-progress :percentage="backtestProgress" :stroke-width="20" :text-inside="true">
                  <span>ÂõûÊµã‰∏≠... {{ backtestProgress }}%</span>
                </el-progress>
              </div>

              <!-- ÂõûÊµãÁªìÊûú -->
              <div v-if="backtestStatus === 'completed'" class="backtest-result">
                <el-result icon="success" title="ÂõûÊµãÂÆåÊàê" sub-title="‰ª•‰∏ãÊòØÂõûÊµãÁªìÊûú">
                  <template #extra>
                    <div class="result-metrics">
                      <el-statistic title="ICÂùáÂÄº" :value="backtestResult.icMean" :precision="4" />
                      <el-statistic title="IC IR" :value="backtestResult.icIr" :precision="2" />
                      <el-statistic title="Rank IC" :value="backtestResult.rankIcMean" :precision="4" />
                      <el-statistic title="Êç¢ÊâãÁéá" :value="backtestResult.turnover" :precision="2" suffix="%" />
                    </div>
                  </template>
                </el-result>
              </div>
            </div>

            <div class="step-actions">
              <el-button @click="currentStep = 0">
                <el-icon class="el-icon--left"><ArrowLeft /></el-icon>
                ‰∏ä‰∏ÄÊ≠•
              </el-button>
              <el-button
                type="primary"
                @click="startBacktest"
                :loading="backtestStatus === 'running'"
                v-if="backtestStatus !== 'completed'"
              >
                <el-icon class="el-icon--left"><TrendCharts /></el-icon>
                ÂºÄÂßãÂõûÊµã
              </el-button>
              <el-button
                type="success"
                @click="currentStep = 2"
                v-if="backtestStatus === 'completed'"
              >
                ‰∏ã‰∏ÄÊ≠•ÔºöÊèê‰∫§ÂÆ°Ê†∏
                <el-icon class="el-icon--right"><ArrowRight /></el-icon>
              </el-button>
            </div>
          </el-card>

          <!-- Ê≠•È™§3: Êèê‰∫§ÂÆ°Ê†∏ -->
          <el-card v-show="currentStep === 2" class="step-card" shadow="never">
            <template #header>
              <div class="card-header">
                <span>‚úÖ Á¨¨‰∏âÊ≠•ÔºöÊèê‰∫§ÂÆ°Ê†∏</span>
              </div>
            </template>
            <div class="submit-section">
              <el-alert
                title="Êèê‰∫§ËØ¥Êòé"
                type="warning"
                :closable="false"
                show-icon
                class="submit-alert"
              >
                <div>Êèê‰∫§ÂêéÂõ†Â≠êÂ∞ÜËøõÂÖ•ÂÆ°Ê†∏ÈòüÂàóÔºåÁä∂ÊÄÅ‰∏∫ <el-tag type="warning" size="small">pending</el-tag>ÔºåÂÆ°Ê†∏ÈÄöËøáÂêéÁä∂ÊÄÅÂèò‰∏∫ <el-tag type="success" size="small">production</el-tag></div>
              </el-alert>

              <!-- ÊúÄÁªàÁ°ÆËÆ§‰ø°ÊÅØ -->
              <div class="final-review">
                <el-descriptions title="Âõ†Â≠êÂÆåÊï¥‰ø°ÊÅØ" :column="1" border>
                  <el-descriptions-item label="Âõ†Â≠êÂêçÁß∞">{{ factorForm.name }}</el-descriptions-item>
                  <el-descriptions-item label="Âõ†Â≠êÂÖ¨Âºè">{{ factorForm.formula }}</el-descriptions-item>
                  <el-descriptions-item label="Âõ†Â≠êÂàÜÁ±ª">{{ getSelectedCategoryName() }}</el-descriptions-item>
                  <el-descriptions-item label="Âõ†Â≠êÊ†áÁ≠æ">
                    <el-tag v-for="tag in getSelectedTagNames()" :key="tag" size="small" style="margin-right: 5px">
                      {{ tag }}
                    </el-tag>
                    <span v-if="factorForm.tags.length === 0">-</span>
                  </el-descriptions-item>
                  <el-descriptions-item label="Âõ†Â≠ê‰ΩúËÄÖ">{{ factorForm.author || '-' }}</el-descriptions-item>
                  <el-descriptions-item label="IC IR">
                    <el-tag :type="getIRTagType(backtestResult.icIr)">{{ backtestResult.icIr }}</el-tag>
                  </el-descriptions-item>
                  <el-descriptions-item label="Rank IC">{{ backtestResult.rankIcMean }}</el-descriptions-item>
                  <el-descriptions-item label="Êç¢ÊâãÁéá">{{ backtestResult.turnover }}%</el-descriptions-item>
                </el-descriptions>
              </div>
            </div>

            <div class="step-actions">
              <el-button @click="currentStep = 1">
                <el-icon class="el-icon--left"><ArrowLeft /></el-icon>
                ‰∏ä‰∏ÄÊ≠•
              </el-button>
              <el-button type="success" @click="submitFactor" :loading="submitting">
                <el-icon class="el-icon--left"><Upload /></el-icon>
                Êèê‰∫§Âà∞ÂÆ°Ê†∏ÈòüÂàó
              </el-button>
            </div>
          </el-card>
        </div>
      </el-tab-pane>

      <!-- Tab3: Âõ†Â≠êÁÆ°ÁêÜ -->
      <el-tab-pane label="‚öôÔ∏è Âõ†Â≠êÁÆ°ÁêÜ" name="manage">
        <div class="manage-container">
          <el-alert
            title="Âõ†Â≠êÁÆ°ÁêÜ"
            type="info"
            :closable="false"
            show-icon
            style="margin-bottom: 20px"
          >
            <div>Êü•ÁúãÂíåÁÆ°ÁêÜ‰Ω†Êèê‰∫§ÁöÑÊâÄÊúâÂõ†Â≠ê</div>
          </el-alert>
          
          <!-- Á≠õÈÄâÂô® -->
          <div class="manage-filters">
            <el-select v-model="manageFilter" placeholder="Á≠õÈÄâÁä∂ÊÄÅ" style="width: 200px">
              <el-option label="ÂÖ®ÈÉ®Âõ†Â≠ê" value="all" />
              <el-option label="ÂæÖÂÆ°Ê†∏" value="pending" />
              <el-option label="ÊµãËØï‰∏≠" value="testing" />
              <el-option label="Áîü‰∫ßÁéØÂ¢É" value="production" />
              <el-option label="Â∑≤Â∫üÂºÉ" value="deprecated" />
            </el-select>
          </div>

          <!-- ÊàëÁöÑÂõ†Â≠êÂàóË°® -->
          <el-table :data="myFactors" style="width: 100%; margin-top: 20px" v-loading="loadingMyFactors">
            <el-table-column prop="factor_code" label="Âõ†Â≠ê‰ª£Á†Å" width="150" />
            <el-table-column prop="factor_name" label="Âõ†Â≠êÂêçÁß∞" width="200" />
            <el-table-column prop="category_l3_name" label="ÂàÜÁ±ª" width="150" />
            <el-table-column prop="status" label="Áä∂ÊÄÅ" width="100">
              <template #default="scope">
                <el-tag :type="getStatusTagType(scope.row.status)" size="small">
                  {{ getStatusLabel(scope.row.status) }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column prop="ic_ir" label="IC IR" width="100">
              <template #default="scope">
                <el-tag :type="getIRTagType(scope.row.ic_ir)" size="small">
                  {{ scope.row.ic_ir?.toFixed(2) || '-' }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column prop="created_at" label="ÂàõÂª∫Êó∂Èó¥" width="180">
              <template #default="scope">
                {{ formatDate(scope.row.created_at) }}
              </template>
            </el-table-column>
            <el-table-column label="Êìç‰Ωú" fixed="right" width="200">
              <template #default="scope">
                <el-button link type="primary" size="small" @click="viewFactorDetail(scope.row)">
                  Êü•ÁúãËØ¶ÊÉÖ
                </el-button>
                <el-button
                  link
                  type="danger"
                  size="small"
                  @click="deprecateFactor(scope.row)"
                  v-if="scope.row.status !== 'deprecated'"
                >
                  Â∫üÂºÉ
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </div>
      </el-tab-pane>
    </el-tabs>

    <!-- ‰∏ãËΩΩÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="downloadDialogVisible"
      title="‰∏ãËΩΩÂõ†Â≠êÊï∞ÊçÆ"
      width="600px"
      :close-on-click-modal="false"
    >
      <el-form :model="downloadForm" label-width="100px">
        <el-form-item label="Âõ†Â≠ê">
          <el-tag type="primary" size="large">
            {{ selectedFactorDetail?.factor_name }}
          </el-tag>
        </el-form-item>
        <el-form-item label="Êó•ÊúüËåÉÂõ¥" required>
          <el-date-picker
            v-model="downloadForm.dateRange"
            type="daterange"
            range-separator="Ëá≥"
            start-placeholder="ÂºÄÂßãÊó•Êúü"
            end-placeholder="ÁªìÊùüÊó•Êúü"
            value-format="YYYY-MM-DD"
            style="width: 100%"
          />
        </el-form-item>
        <el-form-item label="ËÇ°Á•®Ê±†">
          <el-select v-model="downloadForm.stock_pool" style="width: 100%">
            <el-option label="ÂÖ®Â∏ÇÂú∫" value="all" />
            <el-option label="Ê≤™Ê∑±300" value="hs300" />
            <el-option label="‰∏≠ËØÅ500" value="zz500" />
            <el-option label="‰∏≠ËØÅ1000" value="zz1000" />
            <el-option label="ÁßëÂàõ50" value="kc50" />
          </el-select>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="downloadDialogVisible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="handleDownload" :loading="downloading">
          ÂàõÂª∫‰∏ãËΩΩ‰ªªÂä°
        </el-button>
      </template>
    </el-dialog>

    <!-- ÊÄßËÉΩË∂ãÂäøÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="performanceDialogVisible"
      title="Âõ†Â≠êÊÄßËÉΩË∂ãÂäø"
      width="90%"
      top="5vh"
    >
      <div v-loading="loadingPerformance" style="min-height: 400px;">
        <div v-if="performanceData.length > 0">
          <el-alert type="info" :closable="false" style="margin-bottom: 20px;">
            <template #title>
              ÂÖ± {{ performanceData.length }} Â§©Êï∞ÊçÆ | 
              Âπ≥ÂùáIC: {{ avgIC }} | 
              Âπ≥ÂùáRank IC: {{ avgRankIC }} | 
              Âπ≥ÂùáÊç¢Êâã: {{ avgTurnover }}
            </template>
          </el-alert>
          
          <div class="performance-placeholder">
            <el-text type="info">ÊÄßËÉΩË∂ãÂäøÂõæË°®Â±ïÁ§∫Âå∫ÂüüÔºàÊú™Êù•ÂèØÈõÜÊàêÂõæË°®Â∫ìÔºâ</el-text>
          </div>
        </div>
        <el-empty v-else description="ÊöÇÊó†ÊÄßËÉΩÊï∞ÊçÆ" />
      </div>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { 
  Search, Refresh, Download, TrendCharts, Expand,
  ArrowRight, ArrowLeft, Upload, User
} from '@element-plus/icons-vue'

// TabÁä∂ÊÄÅ
const activeMainTab = ref('plaza')
const activeViewTab = ref('category')

// ÂõûÊµã‰∏éÊèê‰∫§Áõ∏ÂÖ≥Áä∂ÊÄÅ
const currentStep = ref(0)  // ÂΩìÂâçÊ≠•È™§: 0-ÂÆö‰πâ 1-ÂõûÊµã 2-Êèê‰∫§
const backtestStatus = ref('idle')  // idle | running | completed | failed
const backtestProgress = ref(0)
const submitting = ref(false)

// ÂÆö‰πâÂõ†Â≠ê - Â∑¶‰æßÂØºËà™
const activeDefineSection = ref('basic')  // ÂΩìÂâçÊøÄÊ¥ªÁöÑÂÆö‰πâÂå∫Âüü
const defineSections = [
  { key: 'basic', label: 'Âü∫Êú¨‰ø°ÊÅØ', icon: 'üìù' },
  { key: 'category', label: 'ÂàÜÁ±ª‰ø°ÊÅØ', icon: 'üìÅ' },
  { key: 'tags', label: 'Ê†áÁ≠æ‰ø°ÊÅØ', icon: 'üè∑Ô∏è' },
  { key: 'code', label: '‰ª£Á†Å‰ø°ÊÅØ', icon: 'üíª' }
]

// Âõ†Â≠êË°®ÂçïÊï∞ÊçÆ
const factorForm = ref({
  name: '',
  formula: '',
  codeType: 'formula',  // formula | python | cpp
  categoryPath: [],
  tags: [] as string[],  // ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÂÄº
  backtestRange: [],
  description: '',
  author: ''  // ‰ªéAPI KeyËá™Âä®ÊèêÂèñ
})

// ÂõûÊµãÁªìÊûú
const backtestResult = ref({
  icMean: 0,
  icIr: 0,
  rankIcMean: 0,
  turnover: 0
})

// Âõ†Â≠êÁÆ°ÁêÜÁõ∏ÂÖ≥
const manageFilter = ref('all')
const myFactors = ref<any[]>([])
const loadingMyFactors = ref(false)

// Êï∞ÊçÆÁä∂ÊÄÅ
const loadingCategories = ref(false)
const loadingFactors = ref(false)
const loadingDetail = ref(false)
const loadingPerformance = ref(false)
const loadingTags = ref(false)
const downloading = ref(false)

// Êï∞ÊçÆ
const searchKeyword = ref('')
const categoryTree = ref<any[]>([])
const factors = ref<any[]>([])     // Âõ†Â≠êÂàóË°®
const selectedFactor = ref<any>(null)
const selectedFactorDetail = ref<any>(null)
const selectedStatus = ref('all')
const selectedCategoryId = ref<number | null>(null)
const selectedCategoryData = ref<any>(null)  // ‰øùÂ≠òÈÄâ‰∏≠ÁöÑÂàÜÁ±ªÂÆåÊï¥Êï∞ÊçÆ
const performanceData = ref<any[]>([])
const totalCount = ref(0)
const allExpanded = ref(false)
const tagGroups = ref<Record<string, any[]>>({})  // Ê†áÁ≠æÂàÜÁªÑ
const selectedTags = ref<string[]>([])  // ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÂÄº

// Áä∂ÊÄÅÈÄâÈ°π
const statusOptions = [
  { value: 'all', label: 'ÂÖ®ÈÉ®', icon: 'üìä' },
  { value: 'testing', label: 'ÊµãËØï‰∏≠', icon: '‚úèÔ∏è' },
  { value: 'pending', label: 'ÂæÖÂÆ°Ê†∏', icon: '‚è≥' },
  { value: 'production', label: 'Áîü‰∫ßÁéØÂ¢É', icon: '‚úÖ' },
  { value: 'deprecated', label: 'Â∑≤Â∫üÂºÉ', icon: '‚ö†Ô∏è' }
]

// Ê†ëÈÖçÁΩÆ
const treeRef = ref()
const treeProps = {
  children: 'children',
  label: 'name'
}

// ‰∏∫Ê†ëËäÇÁÇπÁîüÊàêÂîØ‰∏ÄKeyÔºàfactor_countÁî±ÂêéÁ´ØËøîÂõûÔºå‰∏çÈúÄË¶ÅÂâçÁ´ØËÆ°ÁÆóÔºâ
const treeDataWithUniqueKeys = computed(() => {
  const addUniqueKeys = (nodes: any[], level: number = 1, parentKey: string = ''): any[] => {
    return nodes.map((node) => {
      const uniqueKey = parentKey ? `${parentKey}-${node.id}` : `l${level}-${node.id}`
      
      const newNode = {
        ...node,
        uniqueKey,
        level
        // factor_count Áî±ÂêéÁ´ØAPIÁõ¥Êé•ËøîÂõûÔºåÊó†ÈúÄÂâçÁ´ØËÆ°ÁÆó
      }
      
      // ÈÄíÂΩíÂ§ÑÁêÜÂ≠êËäÇÁÇπ
      if (node.children && node.children.length > 0) {
        newNode.children = addUniqueKeys(node.children, level + 1, uniqueKey)
      }
      
      return newNode
    })
  }
  
  return addUniqueKeys(categoryTree.value)
})

// ÂàÜÈ°µ
const pagination = ref({
  page: 1,
  page_size: 20,
  total: 0
})

// ÂØπËØùÊ°Ü
const downloadDialogVisible = ref(false)
const performanceDialogVisible = ref(false)

// ‰∏ãËΩΩË°®Âçï
const downloadForm = ref({
  dateRange: [] as string[],
  stock_pool: 'all'
})

// ÊòæÁ§∫ÁöÑÂõ†Â≠êÂàóË°®ÔºàÂêéÁ´ØÂ∑≤ÊîØÊåÅ‰∏âÁ∫ßÁ≠õÈÄâÔºå‰∏çÈúÄË¶ÅÂâçÁ´ØÂÜçËøáÊª§Ôºâ
const displayedFactors = computed(() => factors.value)

// ÊÄßËÉΩÁªüËÆ°
const avgIC = computed(() => {
  if (performanceData.value.length === 0) return '-'
  const sum = performanceData.value.reduce((acc, p) => acc + p.ic_value, 0)
  return (sum / performanceData.value.length).toFixed(4)
})

const avgRankIC = computed(() => {
  if (performanceData.value.length === 0) return '-'
  const sum = performanceData.value.reduce((acc, p) => acc + p.rank_ic_value, 0)
  return (sum / performanceData.value.length).toFixed(4)
})

const avgTurnover = computed(() => {
  if (performanceData.value.length === 0) return '-'
  const sum = performanceData.value.reduce((acc, p) => acc + p.turnover, 0)
  return ((sum / performanceData.value.length) * 100).toFixed(2) + '%'
})

// Âä†ËΩΩÂàÜÁ±ªÊ†ë
const loadCategories = async () => {
  loadingCategories.value = true
  try {
    // ËÆæÁΩÆAPI Key
    const apiKeys = await window.electronAPI.config.getApiKeys()
    const defaultKey = apiKeys.find((k: any) => k.isDefault)
    if (!defaultKey) {
      ElMessage.error('ËØ∑ÂÖàÂú®Á≥ªÁªüËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI Key')
      return
    }
    const fullApiKey = await window.electronAPI.config.getFullApiKey(defaultKey.id)
    if (!fullApiKey) {
      ElMessage.error('Ëé∑ÂèñAPI KeyÂ§±Ë¥•')
      return
    }
    await window.electronAPI.factor.setApiKey(fullApiKey)
    
    // Ëé∑ÂèñÂàÜÁ±ªÊ†ë
    const result = await window.electronAPI.factor.getCategories()
    console.log('=== ÂàÜÁ±ªÊ†ëAPIËøîÂõûÊï∞ÊçÆ ===', result)
    if (result.code === 200) {
      categoryTree.value = result.data
      console.log('=== categoryTree.value ===', categoryTree.value)
      // Ê£ÄÊü•Á¨¨‰∏Ä‰∏™ÂàÜÁ±ªÊòØÂê¶Êúâ factor_count
      if (categoryTree.value.length > 0) {
        console.log('=== Á¨¨‰∏Ä‰∏™ÂàÜÁ±ª ===', categoryTree.value[0])
        console.log('=== factor_count ===', categoryTree.value[0].factor_count)
      }
    }
  } catch (error: any) {
    console.error('Âä†ËΩΩÂàÜÁ±ªÂ§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩÂàÜÁ±ªÂ§±Ë¥•: ' + error.message)
  } finally {
    loadingCategories.value = false
  }
}

// Âä†ËΩΩÊ†áÁ≠æÂàóË°®
const loadTags = async () => {
  loadingTags.value = true
  try {
    const result = await window.electronAPI.factor.getTags()
    if (result.code === 200) {
      tagGroups.value = result.data
    }
  } catch (error: any) {
    console.error('Âä†ËΩΩÊ†áÁ≠æÂ§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩÊ†áÁ≠æÂ§±Ë¥•: ' + error.message)
  } finally {
    loadingTags.value = false
  }
}

// Âä†ËΩΩÂõ†Â≠êÂàóË°®
const loadFactors = async () => {
  loadingFactors.value = true
  try {
    const params: any = {
      page: pagination.value.page,
      page_size: pagination.value.page_size
    }
    
    // Áä∂ÊÄÅÁ≠õÈÄâ
    if (selectedStatus.value !== 'all') {
      params.status = selectedStatus.value
    }
    
    // ÂàÜÁ±ªÁ≠õÈÄâÔºöÊ†πÊçÆÈÄâ‰∏≠ÁöÑÂàÜÁ±ªÁ∫ßÂà´Ôºå‰º†ÈÄíÂØπÂ∫îÁöÑÂèÇÊï∞Ôºà‰ªÖÂú®ÊåâÂàÜÁ±ªÊµèËßàÊó∂Ôºâ
    if (activeViewTab.value === 'category' && selectedCategoryData.value) {
      const level = selectedCategoryData.value.level  // Áõ¥Êé•‰ΩøÁî®ËäÇÁÇπÁöÑlevelÂ≠óÊÆµ
      const categoryId = selectedCategoryData.value.id
      
      if (level === 1) {
        params.category_l1_id = categoryId
      } else if (level === 2) {
        params.category_l2_id = categoryId
      } else if (level === 3) {
        params.category_l3_id = categoryId
      }
      
      console.log(`Á≠õÈÄâ${level}Á∫ßÂàÜÁ±ªÔºåID=${categoryId}, Name=${selectedCategoryData.value.name}`)
    }
    
    // Ê†áÁ≠æÁ≠õÈÄâÔºö‰º†ÈÄíÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÂÄºÔºà‰ªÖÂú®ÊåâÊ†áÁ≠æÁ≠õÈÄâÊó∂Ôºâ
    if (activeViewTab.value === 'tags' && selectedTags.value.length > 0) {
      params.tags = selectedTags.value.join(',')
      console.log('Ê†áÁ≠æÁ≠õÈÄâ:', params.tags)
    }
    
    const result = await window.electronAPI.factor.getFactorList(params)
    if (result.code === 200) {
      factors.value = result.data.factors || []
      pagination.value.total = result.data.total
      
      // Â¶ÇÊûúÊòØÂàùÂßãÂä†ËΩΩÔºàÊó†Á≠õÈÄâÊù°‰ª∂ÔºâÔºåÊõ¥Êñ∞ÊÄªÊï∞
      if (!selectedCategoryId.value && selectedStatus.value === 'all' && !searchKeyword.value && selectedTags.value.length === 0) {
        totalCount.value = result.data.total
      }
    }
  } catch (error: any) {
    console.error('Âä†ËΩΩÂõ†Â≠êÂàóË°®Â§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩÂõ†Â≠êÂàóË°®Â§±Ë¥•: ' + error.message)
  } finally {
    loadingFactors.value = false
  }
}

// Ê†ëËäÇÁÇπÁÇπÂáª
const handleNodeClick = (data: any) => {
  // ÁÇπÂáª‰ªªÊÑèÁ∫ßÂà´ÁöÑÂàÜÁ±ªÔºåÈÉΩËøõË°åÁ≠õÈÄâ
  selectedCategoryId.value = data.id
  selectedCategoryData.value = data  // ‰øùÂ≠òÂÆåÊï¥Êï∞ÊçÆÔºåÁî®‰∫éÂà§Êñ≠Á∫ßÂà´
  pagination.value.page = 1
  loadFactors()
}

// Êî∂ÈõÜÊâÄÊúâÊúâÂ≠êËäÇÁÇπÁöÑuniqueKey
const collectNodeKeys = (nodes: any[]): string[] => {
  let keys: string[] = []
  nodes.forEach(node => {
    if (node.children && node.children.length > 0) {
      keys.push(node.uniqueKey)
      keys = keys.concat(collectNodeKeys(node.children))
    }
  })
  return keys
}

// Â±ïÂºÄ/Êî∂Ëµ∑ÂÖ®ÈÉ®
const expandAll = () => {
  allExpanded.value = !allExpanded.value
  if (!treeRef.value) return
  
  if (allExpanded.value) {
    // Â±ïÂºÄÔºöÊî∂ÈõÜÊâÄÊúâÁà∂ËäÇÁÇπÁöÑuniqueKeyÂπ∂Â±ïÂºÄ
    const keys = collectNodeKeys(treeDataWithUniqueKeys.value)
    keys.forEach(key => {
      const node = treeRef.value.getNode(key)
      if (node) {
        node.expanded = true
      }
    })
    console.log('ÂÖ®ÈÉ®Â±ïÂºÄÔºåÂÖ±', keys.length, '‰∏™ËäÇÁÇπ')
  } else {
    // Êî∂Ëµ∑ÔºöÊî∂ÈõÜÊâÄÊúâËäÇÁÇπkeyÂπ∂Êî∂Ëµ∑
    const keys = collectNodeKeys(treeDataWithUniqueKeys.value)
    keys.forEach(key => {
      const node = treeRef.value.getNode(key)
      if (node) {
        node.expanded = false
      }
    })
    console.log('ÂÖ®ÈÉ®Êî∂Ëµ∑')
  }
}

// TabÂàáÊç¢
const handleViewTabChange = () => {
  // ÂàáÊç¢TabÊó∂ÈáçÁΩÆÁ≠õÈÄâÊù°‰ª∂
  selectedCategoryId.value = null
  selectedCategoryData.value = null
  selectedTags.value = []
  selectedStatus.value = 'all'
  pagination.value.page = 1
  loadFactors()
}

// ‰∏ÄÁ∫ßTabÂàáÊç¢
const handleMainTabChange = async (tabName: string) => {
  if (tabName === 'backtest') {
    // ÂàáÊç¢Âà∞ÂõûÊµãTabÊó∂ÔºåÈáçÁΩÆË°®ÂçïÂπ∂Âä†ËΩΩ‰ΩúËÄÖ‰ø°ÊÅØ
    await resetFactorForm()
    // Á°Æ‰øùÂàÜÁ±ªÊ†ëÂíåÊ†áÁ≠æÂ∑≤Âä†ËΩΩ
    if (categoryTree.value.length === 0) {
      await loadCategories()
    }
    if (Object.keys(tagGroups.value).length === 0) {
      await loadTags()
    }
  } else if (tabName === 'manage') {
    // ÂàáÊç¢Âà∞ÁÆ°ÁêÜTabÊó∂ÔºåÂä†ËΩΩÊàëÁöÑÂõ†Â≠ê
    loadMyFactors()
  }
}

// ========== ÂõûÊµã‰∏éÊèê‰∫§Áõ∏ÂÖ≥ÊñπÊ≥ï ==========

// ÈáçÁΩÆÂõ†Â≠êË°®Âçï
const resetFactorForm = async () => {
  currentStep.value = 0
  backtestStatus.value = 'idle'
  backtestProgress.value = 0
  
  // Ëé∑Âèñ‰ΩúËÄÖ‰ø°ÊÅØ
  const author = await getAuthorFromApiKey()
  
  factorForm.value = {
    name: '',
    formula: '',
    codeType: 'formula',
    categoryPath: [],
    tags: [],
    backtestRange: [],
    description: '',
    author: author
  }
  
  // ÈáçÁΩÆÂÆö‰πâÂå∫ÂüüÂØºËà™
  activeDefineSection.value = 'basic'
  backtestResult.value = {
    icMean: 0,
    icIr: 0,
    rankIcMean: 0,
    turnover: 0
  }
}

// ‰ªéAPI KeyËé∑Âèñ‰ΩúËÄÖ‰ø°ÊÅØ
const getAuthorFromApiKey = async () => {
  try {
    const apiKeys = await window.electronAPI.config.getApiKeys()
    const defaultKey = apiKeys.find((k: any) => k.isDefault)
    if (defaultKey && defaultKey.name) {
      return defaultKey.name  // ‰ΩøÁî®API KeyÁöÑÂêçÁß∞‰Ωú‰∏∫‰ΩúËÄÖ
    }
    return 'Êú™Áü•‰ΩúËÄÖ'
  } catch (error) {
    console.error('Ëé∑Âèñ‰ΩúËÄÖ‰ø°ÊÅØÂ§±Ë¥•:', error)
    return 'Êú™Áü•‰ΩúËÄÖ'
  }
}

// ÂàáÊç¢Âõ†Â≠êÊ†áÁ≠æ
const toggleFactorTag = (tagValue: string) => {
  const index = factorForm.value.tags.indexOf(tagValue)
  if (index > -1) {
    factorForm.value.tags.splice(index, 1)
  } else {
    factorForm.value.tags.push(tagValue)
  }
}

// Ëé∑ÂèñÈÄâ‰∏≠Ê†áÁ≠æÁöÑÂêçÁß∞
const getSelectedTagNames = () => {
  const selectedNames: string[] = []
  Object.values(tagGroups.value).forEach(tags => {
    tags.forEach(tag => {
      if (factorForm.value.tags.includes(tag.tag_value)) {
        selectedNames.push(tag.tag_name)
      }
    })
  })
  return selectedNames
}

// Ê£ÄÊü•ÂÆö‰πâÂå∫ÂüüÊòØÂê¶ÂÆåÊàê
const isSectionCompleted = (sectionKey: string) => {
  switch (sectionKey) {
    case 'basic':
      return !!factorForm.value.name
    case 'category':
      return factorForm.value.categoryPath.length > 0
    case 'tags':
      return factorForm.value.tags.length > 0
    case 'code':
      return !!factorForm.value.formula
    default:
      return false
  }
}

// Ëé∑ÂèñÊüêÁ±ªÂûãÂ∑≤ÈÄâÊ†áÁ≠æÊï∞Èáè
const getSelectedTagCountByType = (tagType: string) => {
  const tags = tagGroups.value[tagType] || []
  const tagValues = tags.map(t => t.tag_value)
  return factorForm.value.tags.filter(v => tagValues.includes(v)).length
}

// Ëé∑Âèñ‰ª£Á†ÅÁºñËæëÂô®Âç†‰ΩçÁ¨¶
const getCodePlaceholder = () => {
  const placeholders: Record<string, string> = {
    formula: '‰æãÂ¶Ç: (close - Ref(close, 5)) / Ref(close, 5)',
    python: `# Python Âõ†Â≠êÂÆûÁé∞Á§∫‰æã
def calculate_factor(data):
    """
    ÂèÇÊï∞:
        data: pandas.DataFrameÔºåÂåÖÂê´ open, high, low, close, volume Á≠âÂ≠óÊÆµ
    ËøîÂõû:
        pandas.SeriesÔºåÂõ†Â≠êÂÄº
    """
    # ËÆ°ÁÆó5Êó•Êî∂ÁõäÁéá
    ret_5d = data['close'] / data['close'].shift(5) - 1
    return ret_5d`,
    cpp: `// C++ Âõ†Â≠êÂÆûÁé∞Á§∫‰æã
#include <vector>
#include <cmath>

// Âõ†Â≠êËÆ°ÁÆóÂáΩÊï∞
double calculate_factor(const std::vector<double>& close, int index) {
    if (index < 5) return NAN;
    
    // ËÆ°ÁÆó5Êó•Êî∂ÁõäÁéá
    double ret_5d = (close[index] - close[index - 5]) / close[index - 5];
    
    return ret_5d;
}

// ÊàñËÄÖ‰ΩøÁî®ÂÆåÊï¥ÁöÑÂ∏ÇÂú∫Êï∞ÊçÆÁªìÊûÑ
/*
struct MarketData {
    double open, high, low, close, volume;
    long long timestamp;
};

double calculate_factor(const std::vector<MarketData>& data, int index) {
    // ÂÆûÁé∞Âõ†Â≠êËÆ°ÁÆóÈÄªËæë
    return 0.0;
}
*/`
  }
  return placeholders[factorForm.value.codeType] || ''
}

// Ëé∑Âèñ‰ª£Á†ÅÊèêÁ§∫
const getCodeTip = () => {
  const tips: Record<string, string> = {
    formula: 'ÊîØÊåÅÂ∏∏Áî®ÁÆóÂ≠êÔºöRef(ÂºïÁî®), Mean(ÂùáÂÄº), Std(Ê†áÂáÜÂ∑Æ), Sum(Ê±ÇÂíå), Max(ÊúÄÂ§ß), Min(ÊúÄÂ∞è)Á≠â',
    python: 'ÂáΩÊï∞ÂêçÂøÖÈ°ª‰∏∫ calculate_factorÔºåÂèÇÊï∞‰∏∫ DataFrameÔºåËøîÂõû Series„ÄÇÂèØ‰ΩøÁî® pandas„ÄÅnumpy Á≠âÂ∏∏Áî®Â∫ì',
    cpp: 'C++‰ª£Á†ÅÊèê‰∫§ÂêéÂ∞ÜÁî±ÊúçÂä°Á´ØÁºñËØëÔºàÁºñËØëÊó∂Èó¥Á∫¶30-60ÁßíÔºâ„ÄÇÁºñËØëÊàêÂäüÂêéÊâçËÉΩÂõûÊµã„ÄÇÈÄÇÁî®‰∫éÈ´òÊÄßËÉΩËÆ°ÁÆóÂú∫ÊôØ'
  }
  return tips[factorForm.value.codeType] || ''
}

// Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ËøõÂÖ•ÂõûÊµãÊ≠•È™§
const canGoToBacktest = computed(() => {
  return factorForm.value.name &&
         factorForm.value.formula &&
         factorForm.value.categoryPath.length > 0
})

// ËøõÂÖ•ÂõûÊµãÊ≠•È™§
const goToBacktest = () => {
  if (!canGoToBacktest.value) {
    ElMessage.warning('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÂõ†Â≠ê‰ø°ÊÅØ')
    return
  }
  currentStep.value = 1
}

// ÂºÄÂßãÂõûÊµã
const startBacktest = async () => {
  backtestStatus.value = 'running'
  backtestProgress.value = 0
  
  try {
    // Ê®°ÊãüÂõûÊµãËøáÁ®ã
    const progressInterval = setInterval(() => {
      if (backtestProgress.value < 100) {
        backtestProgress.value += 10
      } else {
        clearInterval(progressInterval)
      }
    }, 300)
    
    // Ê®°ÊãüAPIË∞ÉÁî®
    await new Promise(resolve => setTimeout(resolve, 3000))
    
    // Ê®°ÊãüÂõûÊµãÁªìÊûú
    backtestResult.value = {
      icMean: 0.045 + Math.random() * 0.01,
      icIr: 1.5 + Math.random() * 0.5,
      rankIcMean: 0.052 + Math.random() * 0.01,
      turnover: 12 + Math.random() * 5
    }
    
    backtestStatus.value = 'completed'
    ElMessage.success('ÂõûÊµãÂÆåÊàêÔºÅ')
  } catch (error: any) {
    backtestStatus.value = 'failed'
    ElMessage.error('ÂõûÊµãÂ§±Ë¥•: ' + error.message)
  }
}

// Êèê‰∫§Âõ†Â≠ê
const submitFactor = async () => {
  submitting.value = true
  try {
    // Ê®°ÊãüAPIË∞ÉÁî®
    await new Promise(resolve => setTimeout(resolve, 1500))
    
    ElMessage.success('Âõ†Â≠êÊèê‰∫§ÊàêÂäüÔºÅÂ∑≤ËøõÂÖ•ÂÆ°Ê†∏ÈòüÂàó')
    
    // ÈáçÁΩÆË°®ÂçïÂπ∂ÂàáÊç¢Âà∞ÁÆ°ÁêÜTab
    resetFactorForm()
    activeMainTab.value = 'manage'
    loadMyFactors()
  } catch (error: any) {
    ElMessage.error('Êèê‰∫§Â§±Ë¥•: ' + error.message)
  } finally {
    submitting.value = false
  }
}

// Ëé∑ÂèñÈÄâ‰∏≠ÂàÜÁ±ªÁöÑÂêçÁß∞
const getSelectedCategoryName = () => {
  if (!factorForm.value.categoryPath || factorForm.value.categoryPath.length === 0) {
    return '-'
  }
  
  // ÈÄíÂΩíÊü•ÊâæÂàÜÁ±ªÂêçÁß∞
  const findCategory = (tree: any[], path: number[], index: number = 0): string => {
    if (index >= path.length) return ''
    
    const node = tree.find(n => n.id === path[index])
    if (!node) return ''
    
    if (index === path.length - 1) {
      return node.name
    }
    
    if (node.children && node.children.length > 0) {
      return findCategory(node.children, path, index + 1)
    }
    
    return node.name
  }
  
  return findCategory(categoryTree.value, factorForm.value.categoryPath)
}

// Ëé∑ÂèñIR TagÁ±ªÂûã
const getIRTagType = (ir: number) => {
  if (ir >= 2) return 'success'
  if (ir >= 1.5) return 'primary'
  if (ir >= 1) return 'warning'
  return 'danger'
}

// ========== Âõ†Â≠êÁÆ°ÁêÜÁõ∏ÂÖ≥ÊñπÊ≥ï ==========

// Âä†ËΩΩÊàëÁöÑÂõ†Â≠êÂàóË°®
const loadMyFactors = async () => {
  loadingMyFactors.value = true
  try {
    // Ê®°ÊãüAPIË∞ÉÁî®
    await new Promise(resolve => setTimeout(resolve, 1000))
    
    // Ê®°ÊãüÊï∞ÊçÆ
    myFactors.value = [
      {
        factor_id: 1,
        factor_code: 'MOMENTUM_5D',
        factor_name: '5Êó•Âä®ËÉΩÂõ†Â≠ê',
        category_l3_name: 'Áü≠ÊúüÂä®Èáè',
        status: 'production',
        ic_ir: 1.67,
        created_at: '2025-10-15T10:00:00Z'
      },
      {
        factor_id: 2,
        factor_code: 'VOL_STD_20D',
        factor_name: '20Êó•Ê≥¢Âä®Áéá',
        category_l3_name: 'ÂéÜÂè≤Ê≥¢Âä®Áéá',
        status: 'pending',
        ic_ir: 1.2,
        created_at: '2025-10-18T14:30:00Z'
      }
    ]
  } catch (error: any) {
    ElMessage.error('Âä†ËΩΩÂõ†Â≠êÂàóË°®Â§±Ë¥•: ' + error.message)
  } finally {
    loadingMyFactors.value = false
  }
}

// Ëé∑ÂèñÁä∂ÊÄÅTagÁ±ªÂûã
const getStatusTagType = (status: string) => {
  const types: Record<string, any> = {
    pending: 'warning',
    testing: 'info',
    production: 'success',
    deprecated: 'danger'
  }
  return types[status] || 'info'
}

// Êü•ÁúãÂõ†Â≠êËØ¶ÊÉÖ
const viewFactorDetail = (factor: any) => {
  selectedFactor.value = factor
  selectedFactorDetail.value = factor
  // ËØ¶ÊÉÖÁõ¥Êé•Âú®Âè≥‰æßÈù¢ÊùøÊòæÁ§∫Ôºå‰∏çÈúÄË¶ÅÂºπÁ™ó
}

// Â∫üÂºÉÂõ†Â≠ê
const deprecateFactor = async (factor: any) => {
  try {
    await ElMessageBox.confirm(
      `Á°ÆÂÆöË¶ÅÂ∫üÂºÉÂõ†Â≠ê"${factor.factor_name}"ÂêóÔºü`,
      'Ë≠¶Âëä',
      {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }
    )
    
    // Ê®°ÊãüAPIË∞ÉÁî®
    await new Promise(resolve => setTimeout(resolve, 500))
    
    ElMessage.success('Âõ†Â≠êÂ∑≤Â∫üÂºÉ')
    loadMyFactors()
  } catch {
    // Áî®Êà∑ÂèñÊ∂à
  }
}

// Ê†ºÂºèÂåñÊó•Êúü
const formatDate = (dateStr: string) => {
  if (!dateStr) return '-'
  return new Date(dateStr).toLocaleString('zh-CN')
}

// Ê∏ÖÁ©∫ÊâÄÊúâÊ†áÁ≠æ
const clearAllTags = () => {
  selectedTags.value = []
  pagination.value.page = 1
  loadFactors()
}

// ÂàáÊç¢Ê†áÁ≠æÈÄâÊã©
const toggleTag = (tagValue: string) => {
  const index = selectedTags.value.indexOf(tagValue)
  if (index > -1) {
    selectedTags.value.splice(index, 1)
  } else {
    selectedTags.value.push(tagValue)
  }
  pagination.value.page = 1
  loadFactors()
}

// Ëé∑ÂèñÊ†áÁ≠æÁ±ªÂûãÁöÑ‰∏≠ÊñáÂêç
const getTagTypeLabel = (tagType: string) => {
  const labels: Record<string, string> = {
    // Âü∫Á°ÄÂàÜÁ±ª
    frequency: 'Êõ¥Êñ∞È¢ëÁéá',
    level: 'Âõ†Â≠êÁ∫ßÂà´',
    attribute: 'Âõ†Â≠êÂ±ûÊÄß',
    computation: 'ËÆ°ÁÆóÊñπÂºè',
    data_source: 'Êï∞ÊçÆÊù•Ê∫ê',
    data_quality: 'Êï∞ÊçÆË¥®Èáè',
    
    // Â∫îÁî®Áõ∏ÂÖ≥
    application: 'Â∫îÁî®Âú∫ÊôØ',
    strategy: 'Á≠ñÁï•Á±ªÂûã',
    usage: '‰ΩøÁî®ÊñπÂºè',
    holding_period: 'ÊåÅÊúâÂë®Êúü',
    universe: 'ËÇ°Á•®Ê±†',
    
    // Â∏ÇÂú∫Áõ∏ÂÖ≥
    industry: 'Ë°å‰∏ö',
    market: 'Â∏ÇÂú∫',
    asset_class: 'ËµÑ‰∫ßÁ±ªÂà´',
    
    // È£éÊ†ºÁõ∏ÂÖ≥
    style: 'È£éÊ†º',
    factor_type: 'Âõ†Â≠êÁ±ªÂûã',
    investment_style: 'ÊäïËµÑÈ£éÊ†º',
    
    // ÊäÄÊúØÁõ∏ÂÖ≥
    complexity: 'Â§çÊùÇÂ∫¶',
    stability: 'Á®≥ÂÆöÊÄß',
    
    // ÂÖ∂‰ªñ
    region: 'Âú∞Âüü',
    period: 'Âë®Êúü',
    target: 'ÁõÆÊ†á'
  }
  return labels[tagType] || tagType
}

// ÊêúÁ¥¢
const handleSearch = () => {
  pagination.value.page = 1
  loadFactors()
}

// ÈÄâÊã©Âõ†Â≠ê
const selectFactor = async (factor: any) => {
  selectedFactor.value = factor
  loadingDetail.value = true
  
  try {
    const result = await window.electronAPI.factor.getFactorDetail(factor.factor_id)
    if (result.code === 200) {
      selectedFactorDetail.value = result.data
    }
  } catch (error: any) {
    console.error('Âä†ËΩΩÂõ†Â≠êËØ¶ÊÉÖÂ§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩÂõ†Â≠êËØ¶ÊÉÖÂ§±Ë¥•: ' + error.message)
  } finally {
    loadingDetail.value = false
  }
}

// ÊòæÁ§∫‰∏ãËΩΩÂØπËØùÊ°Ü
const showDownloadDialog = () => {
  downloadForm.value = {
    dateRange: [],
    stock_pool: 'all'
  }
  downloadDialogVisible.value = true
}

// ‰∏ãËΩΩ
const handleDownload = async () => {
  if (!downloadForm.value.dateRange || downloadForm.value.dateRange.length !== 2) {
    ElMessage.warning('ËØ∑ÈÄâÊã©Êó•ÊúüËåÉÂõ¥')
    return
  }
  
  downloading.value = true
  
  try {
    const result = await window.electronAPI.factor.downloadFactorData({
      factor_ids: [selectedFactorDetail.value.factor_id],
      start_date: downloadForm.value.dateRange[0],
      end_date: downloadForm.value.dateRange[1],
      stock_pool: downloadForm.value.stock_pool
    })
    
    if (result.code === 200) {
      ElMessage.success(`‰∏ãËΩΩ‰ªªÂä°ÂàõÂª∫ÊàêÂäüÔºÅ‰ªªÂä°ID: ${result.data.task_id}`)
      downloadDialogVisible.value = false
    }
  } catch (error: any) {
    console.error('ÂàõÂª∫‰∏ãËΩΩ‰ªªÂä°Â§±Ë¥•:', error)
    ElMessage.error('ÂàõÂª∫‰∏ãËΩΩ‰ªªÂä°Â§±Ë¥•: ' + error.message)
  } finally {
    downloading.value = false
  }
}

// Êü•ÁúãÊÄßËÉΩË∂ãÂäø
const viewPerformanceTrend = async () => {
  if (!selectedFactorDetail.value) return
  
  performanceDialogVisible.value = true
  loadingPerformance.value = true
  
  try {
    const result = await window.electronAPI.factor.getFactorPerformance(
      selectedFactorDetail.value.factor_id,
      60
    )
    if (result.code === 200) {
      performanceData.value = result.data.performances
    }
  } catch (error: any) {
    console.error('Âä†ËΩΩÊÄßËÉΩÊï∞ÊçÆÂ§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩÊÄßËÉΩÊï∞ÊçÆÂ§±Ë¥•: ' + error.message)
  } finally {
    loadingPerformance.value = false
  }
}

// Â∑•ÂÖ∑ÂáΩÊï∞
const getStatusColor = (status: string) => {
  const colors: any = {
    production: 'success',
    testing: 'warning',
    deprecated: 'info',
    pending: 'primary'
  }
  return colors[status] || ''
}

const getStatusLabel = (status: string) => {
  const labels: any = {
    all: 'ÂÖ®ÈÉ®',
    production: 'Áîü‰∫ßÁéØÂ¢É',
    testing: 'ÊµãËØï‰∏≠',
    deprecated: 'Â∑≤Â∫üÂºÉ',
    pending: 'ÂæÖÂÆ°Ê†∏'
  }
  return labels[status] || status
}

const getICColor = (value?: number) => {
  if (!value) return ''
  if (value > 0.05) return 'success'
  if (value > 0.02) return 'primary'
  if (value < 0) return 'danger'
  return ''
}

// ÂàùÂßãÂåñ
onMounted(async () => {
  await loadCategories()  // ÂàÜÁ±ªÊ†ë‰∏≠Â∑≤ÂåÖÂê´factor_countÔºåÁî±ÂêéÁ´ØÁªüËÆ°
  await loadTags()
  await loadFactors()
})
</script>

<style scoped lang="scss">
.factor-library-page {
  max-width: 1800px;
  margin: 0 auto;
  padding: 0;

  .main-tabs {
    :deep(.el-tabs__content) {
      padding: 0;
    }
    
    :deep(.el-tabs__header) {
      margin-bottom: 0;
    }
  }

  .view-tabs {
    margin-bottom: 15px;
    padding: 0 20px;
    
    :deep(.el-tabs__header) {
      margin-bottom: 10px;
    }
  }

  .search-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    padding: 0 20px;
    
    .el-input {
      flex: 1;
      max-width: 500px;
    }
  }

  .content-layout {
    display: grid;
    grid-template-columns: 240px 1fr 400px;
    gap: 15px;
    padding: 0 20px 20px;
  }

  // Â∑¶‰æßÂàÜÁ±ªÊ†ë
  .left-panel {
    border: 1px solid #e4e7ed;
    border-radius: 8px;
    overflow: hidden;
    background: white;
    height: calc(100vh - 260px);
    display: flex;
    flex-direction: column;
    
    .panel-header {
      padding: 12px 15px;
      background: #f5f7fa;
      border-bottom: 1px solid #e4e7ed;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
      height: 52px;
      box-sizing: border-box;
    }
    
    .category-tree {
      padding: 10px;
      flex: 1;
      overflow-y: auto;
      
      .tree-node {
        display: flex;
        align-items: center;
        gap: 8px;
        
        .node-label {
          flex: 1;
        }
        
        .node-count {
          color: #909399;
          font-size: 12px;
        }
      }
    }
    
    .tags-container {
      padding: 15px;
      flex: 1;
      overflow-y: auto;
      
      .tag-group {
        margin-bottom: 20px;
        
        .tag-group-title {
          font-weight: 500;
          font-size: 14px;
          color: #303133;
          margin-bottom: 10px;
          padding-bottom: 8px;
          border-bottom: 1px solid #e4e7ed;
        }
        
        .tag-items {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
          
          .tag-item {
            cursor: pointer;
            font-size: 12px;
          }
        }
      }
    }
  }

  // ‰∏≠Èó¥Âõ†Â≠êÂàóË°®
  .middle-panel {
    border: 1px solid #e4e7ed;
    border-radius: 8px;
    overflow: hidden;
    background: white;
    height: calc(100vh - 260px);
    display: flex;
    flex-direction: column;
    
    .panel-header {
      padding: 12px 15px;
      background: #f5f7fa;
      border-bottom: 1px solid #e4e7ed;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
      height: 52px;
      box-sizing: border-box;
    }
    
    .factor-list {
      padding: 15px;
      flex: 1;
      overflow-y: auto;
      
      .factor-card {
        padding: 12px 15px;
        border: 1px solid #e4e7ed;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
        
        &:hover {
          border-color: #409EFF;
          box-shadow: 0 2px 12px rgba(64, 158, 255, 0.1);
        }
        
        &.active {
          border-color: #409EFF;
          background: #ecf5ff;
        }
        
        .factor-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 6px;
          
          .factor-code {
            font-family: monospace;
            font-weight: 600;
            font-size: 13px;
          }
        }
        
        .factor-name {
          font-size: 13px;
          color: #606266;
          margin-bottom: 6px;
        }
        
        .factor-category {
          font-size: 11px;
          color: #909399;
          margin-bottom: 6px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .factor-metrics {
          display: flex;
          gap: 8px;
        }
      }
      
      .pagination-wrapper {
        margin-top: 20px;
        display: flex;
        justify-content: center;
      }
    }
  }

  // Âè≥‰æßËØ¶ÊÉÖ
  .right-panel {
    border: 1px solid #e4e7ed;
    border-radius: 8px;
    background: white;
    height: calc(100vh - 260px);
    display: flex;
    flex-direction: column;
    
    .panel-header {
      padding: 12px 15px;
      background: #f5f7fa;
      border-bottom: 1px solid #e4e7ed;
      font-weight: 500;
      height: 52px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
    }
    
    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .empty-state {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .factor-detail {
      .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e4e7ed;
        
        h3 {
          margin: 0;
          font-size: 18px;
        }
      }
      
      .info-section {
        margin-bottom: 20px;
        
        :deep(.el-card__header) {
          padding: 12px 15px;
          background: #f5f7fa;
        }
        
        :deep(.el-card__body) {
          padding: 15px;
        }
        
        .section-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        
        .section-title {
          font-weight: 500;
          margin-bottom: 10px;
          color: #606266;
        }
        
        .tags-section {
          margin-top: 15px;
          padding-top: 15px;
          border-top: 1px solid #e4e7ed;
          
          .factor-tag {
            margin-right: 8px;
            margin-bottom: 8px;
          }
        }
      }
      
      .action-buttons {
        text-align: center;
        margin-top: 20px;
      }
    }
  }

  .performance-placeholder {
    min-height: 350px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f7fa;
    border-radius: 8px;
    border: 2px dashed #dcdfe6;
  }

  // ========== ÂõûÊµã‰∏éÊèê‰∫§Ê†∑Âºè ==========
  .backtest-submit-container {
    padding: 20px;

    .steps-container {
      margin-bottom: 30px;
    }

    .step-card {
      margin-top: 20px;
      
      .card-header {
        font-weight: 500;
        font-size: 16px;
      }
    }

    // ÂÆö‰πâÂõ†Â≠ê - Â∑¶Âè≥ÂàÜÊ†èÂ∏ÉÂ±Ä
    .define-layout {
      display: flex;
      gap: 20px;
      min-height: 500px;
      margin: 20px 0;

      .define-nav {
        width: 200px;
        min-width: 200px;
        border: 1px solid #e4e7ed;
        border-radius: 8px;
        padding: 10px;
        background: #fafafa;
        flex-shrink: 0;

        .nav-item {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 12px 15px;
          border-radius: 6px;
          cursor: pointer;
          transition: all 0.3s;
          margin-bottom: 8px;
          position: relative;

          &:hover {
            background: #e8f4ff;
          }

          &.active {
            background: #409eff;
            color: white;

            .nav-label {
              font-weight: 500;
            }
          }

          .nav-icon {
            font-size: 20px;
          }

          .nav-label {
            flex: 1;
            font-size: 14px;
          }

          .check-icon {
            color: #67C23A;
            font-weight: bold;
            font-size: 16px;
          }
        }
      }

      .define-content {
        flex: 1;
        border: 1px solid #e4e7ed;
        border-radius: 8px;
        padding: 30px;
        background: white;
        overflow-y: auto;
        max-height: 600px;

        .section-panel {
          .section-title {
            font-size: 18px;
            margin: 0 0 20px 0;
            color: #303133;
            border-bottom: 2px solid #409eff;
            padding-bottom: 10px;
          }

          .form-tip {
            margin-top: 8px;
          }

          .code-editor {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
          }
        }

        .tags-section {
          .tag-group-block {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e4e7ed;
            border-radius: 6px;
            background: #fafafa;

            &:last-child {
              margin-bottom: 0;
            }

            .tag-group-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 12px;

              .tag-type-title {
                font-size: 14px;
                font-weight: 500;
                color: #303133;
              }
            }

            .tag-items-block {
              display: flex;
              flex-wrap: wrap;
              gap: 10px;
            }
          }
        }
      }
    }

    .step-actions {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e4e7ed;
    }

    .backtest-section {
      .backtest-alert {
        margin-bottom: 20px;
      }

      .factor-info {
        margin: 20px 0;
      }

      .backtest-progress {
        margin: 30px 0;
      }

      .backtest-result {
        margin: 20px 0;

        .result-metrics {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 20px;
          margin-top: 20px;
        }
      }
    }

    .submit-section {
      .submit-alert {
        margin-bottom: 20px;
      }

      .final-review {
        margin: 20px 0;
      }
    }
  }

  // ========== Âõ†Â≠êÁÆ°ÁêÜÊ†∑Âºè ==========
  .manage-container {
    padding: 20px;

    .manage-filters {
      margin-bottom: 20px;
    }
  }
}
</style>
